<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Phaser Tilemap Game</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #2d2d2d;
        }
    </style>
</head>
<body>
    <div id="phaser-game"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const config = {
                type: Phaser.AUTO,
                width: 800,
                height: 600,
                parent: 'phaser-game',
                backgroundColor: '#000000',
                physics: {
                    default: "arcade",
                    arcade: {
                        gravity: { y: 200 },
                        debug: false
                    },
                },
                scene: {
                    preload: preload,
                    create: create,
                }
            };

            const game = new Phaser.Game(config);

            function preload() {
                // Load the tilemap with embedded tileset
                this.load.tilemapTiledJSON('map', 'town_embedded.json');
                
                // Load the tileset image
                this.load.image('tiles', 'tilemap_packed.png');
                
                // Load other game assets
                this.load.image("plane", "https://labs.phaser.io/assets/sprites/ww2plane.png");
                this.load.image("green", "https://labs.phaser.io/assets/particles/green.png");
            }

            function create() {
                try {
                    // Create the tilemap
                    const map = this.make.tilemap({ key: 'map' });
                    
                    // Add the tileset - use the name from your Tiled project
                    const tileset = map.addTilesetImage('town', 'tiles');
                    
                    // Create all layers from the map
                    let layersCreated = 0;
                    map.layers.forEach(layerData => {
                        const layer = map.createLayer(layerData.name, tileset, 0, 0);
                        console.log(`Created layer: ${layerData.name}`);
                        layersCreated++;
                    });
                    
                    console.log(`Created ${layersCreated} layers from the map`);
                    
                    // Add the player sprite
                    const particles = this.add.particles("green");
                    const emitter = particles.createEmitter({
                        speed: 100,
                        scale: { start: 1, end: 0 },
                        blendMode: "ADD",
                    });
                    
                    const plane = this.physics.add.image(400, 100, "plane");
                    plane.setVelocity(100, 200);
                    plane.setBounce(1, 1);
                    plane.setCollideWorldBounds(true);
                    emitter.startFollow(plane);
                    
                } catch (error) {
                    console.error("Error loading tilemap:", error);
                    
                    // Show error message
                    this.add.text(20, 20, "Error loading map: " + error.message, {
                        font: "16px Arial",
                        fill: "red"
                    });
                }
            }
        });
    </script>
</body>
</html>